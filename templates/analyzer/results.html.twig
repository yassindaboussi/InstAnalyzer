{# templates/analyzer/results.html.twig #}
{% extends 'base.html.twig' %}

{% block body %}
<div class="max-w-7xl mx-auto animate-on-scroll">
    {# Compute users who don't follow back #}
    {% set following_users = following|keys %}
    {% set follower_users = followers|keys %}

    {% set notFollowingBack = [] %}
    {% for user in following_users %}
        {% if user not in follower_users %}
            {% set timestamp = following[user].timestamp ?? following[user] ?? 0 %}
            {% set notFollowingBack = notFollowingBack|merge([{
                username: user,
                date: timestamp ? timestamp|date('Y-m-d') : null,
                timestamp: timestamp
            }]) %}
        {% endif %}
    {% endfor %}

    {# Stats #}
    {% set stats = [
        {count: followers|length, label: 'Followers', color: 'emerald', icon: 'users'},
        {count: following|length, label: 'Following', color: 'purple', icon: 'user-plus'},
        {count: notFollowingBack|length, label: "Don't Follow Back", color: 'red', icon: 'user-x'}
    ] %}

    {# Fix: Use reduce() to get max value instead of non-existent |max filter #}
    {% set max_count = [followers|length, following|length, notFollowingBack|length]|reduce((carry, v) => carry > v ? carry : v, 0) %}

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        {% for stat in stats %}
        <div class="glass-effect rounded-xl p-5 hover:shadow-card-hover transition-all stat-card">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-xl bg-{{ stat.color }}-100 dark:bg-{{ stat.color }}-900/30 flex items-center justify-center">
                        <i data-lucide="{{ stat.icon }}" class="w-7 h-7 text-{{ stat.color }}-600 dark:text-{{ stat.color }}-400"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ stat.count|number_format }}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{{ stat.label }}</div>
                    </div>
                </div>
                <div class="w-16 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-{{ stat.color }}-500 rounded-full transition-all duration-1000"
                         style="width: {{ max_count > 0 ? (stat.count / max_count) * 100 : 0 }}%"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Don't Follow You Back List -->
    <div class="glass-effect rounded-3xl overflow-hidden shadow-soft">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                        <i data-lucide="user-x" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Don't Follow You Back</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400" id="not-following-count">{{ notFollowingBack|length }} accounts</p>
                    </div>
                </div>
                <button onclick="copyToClipboard('{{ notFollowingBack|map(u => u.username)|join(', ') }}')"
                        class="px-4 py-2 text-sm font-medium rounded-lg bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors flex items-center gap-2">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    Copy All
                </button>
            </div>

            <!-- Sort & Open Tabs -->
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Sort by:</span>
                    <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                        <button onclick="sortNotFollowingBack('newest', this)" data-sort="newest"
                                class="sort-btn px-4 py-1.5 text-xs font-medium rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white shadow-sm">Newest</button>
                        <button onclick="sortNotFollowingBack('oldest', this)" data-sort="oldest"
                                class="sort-btn px-4 py-1.5 text-xs font-medium rounded-md text-gray-600 dark:text-gray-400 hover:text-gray-800">Oldest</button>
                        <button onclick="sortNotFollowingBack('name', this)" data-sort="name"
                                class="sort-btn px-4 py-1.5 text-xs font-medium rounded-md text-gray-600 dark:text-gray-400 hover:text-gray-800">Name</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openUsersInNewTabs(5)" class="px-3 py-1.5 text-xs rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 hover:bg-blue-100 flex items-center gap-1">
                        <i data-lucide="external-link" class="w-3.5 h-3.5"></i> 5 Tabs
                    </button>
                    <button onclick="openUsersInNewTabs(10)" class="px-3 py-1.5 text-xs rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 hover:bg-blue-100 flex items-center gap-1">
                        <i data-lucide="external-link" class="w-3.5 h-3.5"></i> 10 Tabs
                    </button>
                </div>
            </div>
        </div>

        <div class="max-h-[520px] overflow-y-auto user-list" id="notFollowingBack-list">
            {% if notFollowingBack|length > 0 %}
                {% for user in notFollowingBack|sort((a,b) => b.timestamp <=> a.timestamp) %}
                <div class="user-item flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors border-b border-gray-100 dark:border-gray-800 last:border-0"
                     data-username="{{ user.username }}"
                     data-timestamp="{{ user.timestamp|default(0) }}">
                    <div class="flex items-center space-x-4">
                        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-red-400 to-pink-600 flex items-center justify-center text-white font-bold text-sm">
                            {{ user.username|first|upper }}
                        </div>
                        <div>
                            <a href="https://instagram.com/{{ user.username }}" target="_blank" rel="noopener noreferrer"
                               class="font-medium text-gray-800 dark:text-white hover:text-primary-500 transition-colors">
                                @{{ user.username }}
                            </a>
                            {% if user.date %}
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                Followed {{ user.date|date('M d, Y') }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="https://instagram.com/{{ user.username }}" target="_blank" rel="noopener noreferrer"
                           class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Open profile">
                            <i data-lucide="external-link" class="w-4.5 h-4.5 text-gray-500"></i>
                        </a>
                        <button onclick="copyUsername('{{ user.username }}')"
                                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Copy username">
                            <i data-lucide="copy" class="w-4.5 h-4.5 text-gray-500"></i>
                        </button>
                        <button onclick="removeUser('{{ user.username }}')"
                                class="p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 hover:text-red-700 transition-colors" title="Remove">
                            <i data-lucide="trash-2" class="w-4.5 h-4.5"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="p-12 text-center">
                    <div class="w-20 h-20 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check-circle" class="w-12 h-12 text-green-600 dark:text-green-400"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Perfect Balance!</h4>
                    <p class="text-gray-600 dark:text-gray-400">Everyone you follow follows you back</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bottom Cards -->
    <div class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass-effect rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                    <i data-lucide="lightbulb" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                </div>
                <h4 class="font-bold text-gray-800 dark:text-white">Insight</h4>
            </div>
            {% set ratio = following|length > 0 ? (notFollowingBack|length / following|length) * 100 : 0 %}
            <p class="text-sm text-gray-600 dark:text-gray-400">
                {% if ratio > 30 %}
                    High unfollow rate ({{ ratio|round }}%). Time to clean up!
                {% elseif ratio > 15 %}
                    Balanced network ({{ ratio|round }}%). Keep it up!
                {% else %}
                    Excellent ratio ({{ ratio|round }}%) â€” healthy engagement!
                {% endif %}
            </p>
        </div>

        <div class="glass-effect rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                    <i data-lucide="download" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                </div>
                <h4 class="font-bold text-gray-800 dark:text-white">Export Results</h4>
            </div>
            <div class="space-y-3">
                <button onclick="exportData('csv')" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 transition-colors">
                    <div class="flex items-center gap-3">
                        <i data-lucide="file-spreadsheet" class="w-5 h-5 text-gray-500"></i>
                        <span class="text-sm font-medium">Export as CSV</span>
                    </div>
                    <i data-lucide="arrow-right" class="w-4 h-4 text-gray-400"></i>
                </button>
                <button onclick="exportData('json')" class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700 transition-colors">
                    <div class="flex items-center gap-3">
                        <i data-lucide="file-code" class="w-5 h-5 text-gray-500"></i>
                        <span class="text-sm font-medium">Export as JSON</span>
                    </div>
                    <i data-lucide="arrow-right" class="w-4 h-4 text-gray-400"></i>
                </button>
            </div>
        </div>

        <div class="glass-effect rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                    <i data-lucide="refresh-cw" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
                </div>
                <h4 class="font-bold text-gray-800 dark:text-white">New Analysis</h4>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Ready for another account?
            </p>
            <a href="{{ path('app_home') }}" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 bg-gradient-to-r from-primary-500 to-purple-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">
                <i data-lucide="plus" class="w-5 h-5"></i>
                Start New Analysis
            </a>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => showToast('Copied all usernames!', 'success'));
    }

    function copyUsername(username) {
        navigator.clipboard.writeText(username).then(() => showToast(`@${username} copied!`, 'success'));
    }

    function exportData(format) {
        const usernames = Array.from(document.querySelectorAll('#notFollowingBack-list .user-item'))
            .map(el => el.dataset.username);

        let content, type, ext;
        if (format === 'csv') {
            content = "Username\n" + usernames.join("\n");
            type = "text/csv";
            ext = "csv";
        } else {
            content = JSON.stringify({ notFollowingBack: usernames, exportedAt: new Date().toISOString() }, null, 2);
            type = "application/json";
            ext = "json";
        }

        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `instanalyzer-${format}-${new Date().toISOString().slice(0,10)}.${ext}`;
        a.click();
        URL.revokeObjectURL(url);
        showToast(`Exported as ${format.toUpperCase()}`, 'success');
    }

    function sortNotFollowingBack(type, btn) {
        const list = document.getElementById('notFollowingBack-list');
        const items = Array.from(list.querySelectorAll('.user-item'));

        document.querySelectorAll('.sort-btn').forEach(b => {
            b.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white', 'shadow-sm');
            b.classList.add('text-gray-600', 'dark:text-gray-400');
        });
        btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white', 'shadow-sm');

        items.sort((a, b) => {
            if (type === 'name') return a.dataset.username.localeCompare(b.dataset.username);
            const ta = parseInt(a.dataset.timestamp) || 0;
            const tb = parseInt(b.dataset.timestamp) || 0;
            return type === 'newest' ? tb - ta : ta - tb;
        });

        items.forEach(item => list.appendChild(item));
        showToast(`Sorted by ${type}`, 'success');
    }

    function openUsersInNewTabs(count) {
        const usernames = Array.from(document.querySelectorAll('#notFollowingBack-list .user-item'))
            .slice(0, count)
            .map(el => el.dataset.username);
        usernames.forEach(u => window.open(`https://instagram.com/${u}`, '_blank'));
        showToast(`Opened ${usernames.length} profiles`, 'success');
    }

    function removeUser(username) {
        const item = document.querySelector(`[data-username="${username}"]`);
        if (item) {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                item.remove();
                const countEl = document.getElementById('not-following-count');
                if (countEl) {
                    const current = parseInt(countEl.textContent.match(/\d+/)[0]) - 1;
                    countEl.textContent = countEl.textContent.replace(/\d+/, current);
                }
                showToast(`@${username} removed`, 'success');
            }, 300);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const newestBtn = document.querySelector('.sort-btn[data-sort="newest"]');
        if (newestBtn) newestBtn.click();
        lucide.createIcons();
    });
</script>
{% endblock %}